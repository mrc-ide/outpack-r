<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Outpack query DSL • outpack</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Outpack query DSL">
<meta property="og:description" content="outpack">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">outpack</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/query.html">Outpack query DSL</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/outpack/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="query_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Outpack query DSL</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/outpack/blob/HEAD/vignettes/query.Rmd" class="external-link"><code>vignettes/query.Rmd</code></a></small>
      <div class="hidden name"><code>query.Rmd</code></div>

    </div>

    
    
<p>Outpack includes a query DSL (domain specific language), extending the one used by orderly (see <a href="https://www.vaccineimpact.org/orderly/reference/orderly_search.html" class="external-link"><code>orderly::orderly_search()</code></a>).</p>
<p>Queries are used in identifying ids to pull in as dependencies, so rather than providing an identifier, you might want to depend on</p>
<ul>
<li>the most recent copy of a packet with a particular name</li>
<li>…produced in some date range</li>
<li>…with some particular set of parameter values</li>
<li>…that produced a particular file</li>
<li>…that was depended on by some other packet</li>
<li>…that can be found on a particular location</li>
</ul>
<p>Not all of this is supported as of the current version of outpack, and <em>using</em> the queries seemlessly is also not supported!</p>
<div class="section level2">
<h2 id="structure-of-queries">Structure of queries<a class="anchor" aria-label="anchor" href="#structure-of-queries"></a>
</h2>
<p>The most simple query is</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">latest</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>which finds the most recent packet; this is unlikely to be very useful without scoping - see below.</p>
<p>More complex queries are expressed in a syntax that is valid R (this is also valid Julia and close to valid Python). A complex query is composed of “tests”</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">name</span> <span class="op">==</span> <span class="st">"some_name"</span></span>
<span><span class="va">parameter</span><span class="op">:</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">1</span></span></code></pre></div>
<p>Every “test” uses a boolean operator (<code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, <code>&gt;=</code>, <code>==</code>, or <code>!=</code>) and the left and right hand side can be one of:</p>
<ul>
<li>a lookup into the outpack metadata (<code>parameter:x</code> is the value of a parameter called <code>x</code>, <code>name</code> is the name of the packet)</li>
<li>a lookup into the provided data <code>pars</code> (<code>this:x</code> is the value of <code>pars$x</code>)</li>
<li>a literal value (e.g., <code>"some_name"</code>, <code>1</code>, or <code>TRUE</code>)</li>
</ul>
<p>Tests can be grouped together <code>(</code>, <code>!</code>, <code>&amp;&amp;</code>, and <code>||</code> as you might expect:</p>
<ul>
<li>
<code>parameter:x == 1 || parameter:x == 2</code> finds packets where the parameter <code>x</code> was 1 or 2</li>
<li>
<code>name == "data" &amp;&amp; parameter:x &gt; 3</code> finds packets called “data” where parameter <code>x</code> is greater than 3</li>
<li>
<code>(parameter:y == 2) &amp;&amp; !(parameter:x == 1 || parameter:x == 2)</code> finds where parameter <code>y</code> is 2 and parameter <code>x</code> is anything other than 1 or 2 (could also be written <code>(parameter:y == 2) &amp;&amp; (parameter:x != 1 &amp;&amp; parameter:x != 2)</code>)</li>
</ul>
<p>There are two other functions</p>
<ul>
<li>
<code>latest(expr)</code> finds the latest packet satifying <code>expr</code> - it always returns a length 1 character, but this is <code>NA_character_</code> if no suitable packet is found</li>
<li>
<code>at_location("loc1", "loc2")</code> finds packets that are available at any of the locations provided (here, <code>"loc1"</code> or <code>"loc2"</code>; any number of locations can be provided, these must be string literals).</li>
</ul>
</div>
<div class="section level2">
<h2 id="scoping-queries">Scoping queries<a class="anchor" aria-label="anchor" href="#scoping-queries"></a>
</h2>
<p>Scoping queries can be used to reduce the set of packets that are searched over. They essentially join together with the main query as <code>(scope) &amp;&amp; (expr)</code>, except that we only look values up in <code>expr</code> if the query <code>scope</code> is satisfied. This is useful if you want to limit the search to a particular name or location but perform some more detailed search.</p>
<p>For example, the query</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">outpack_query</span>(<span class="kw">quote</span>(parameter<span class="op">:</span>x <span class="op">==</span><span class="st"> </span><span class="dv">1</span>), <span class="kw">quote</span>(name <span class="op">==</span><span class="st"> "data"</span>))<span class="st">`</span></span></code></pre></div>
<p>is equivalent to</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/outpack_query.html">outpack_query</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="va">parameter</span><span class="op">:</span><span class="va">x</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;&amp;</span> <span class="va">name</span> <span class="op">==</span> <span class="st">"data"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>except that in the former we only check the parameter values of packets called “data”.</p>
<p>Orderly will use this functionality when resolving dependencies.</p>
</div>
<div class="section level2">
<h2 id="possible-future-queries-and-interface-improvements">Possible future queries and interface improvements<a class="anchor" aria-label="anchor" href="#possible-future-queries-and-interface-improvements"></a>
</h2>
<div class="section level3">
<h3 id="simple-things">Simple things<a class="anchor" aria-label="anchor" href="#simple-things"></a>
</h3>
<p>orderly supports <code>is.null(parameter:x)</code> but we might generalise this and support</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parameter</span><span class="op">:</span><span class="va">x</span> <span class="op">==</span> <span class="cn">NULL</span></span></code></pre></div>
<p>However, in Python we have <code>None</code> and in Julia <code>nothing</code>, so this complicates things. Alternatively we could use <code>missing(parameter:x)</code>?</p>
</div>
<div class="section level3">
<h3 id="more-complex">More complex<a class="anchor" aria-label="anchor" href="#more-complex"></a>
</h3>
<p>It might be useful to do a lookup against a subquery</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">latest</span><span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="op">(</span><span class="fu">latest</span><span class="op">(</span><span class="va">subquery</span><span class="op">)</span><span class="op">)</span><span class="op">:</span><span class="va">name</span><span class="op">)</span></span></code></pre></div>
<p>Similarily, we might want to look up parameter values</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">latest</span><span class="op">(</span><span class="va">parameter</span><span class="op">:</span><span class="va">x</span> <span class="op">==</span> <span class="op">(</span><span class="fu">latest</span><span class="op">(</span><span class="va">subquery</span><span class="op">)</span><span class="op">)</span><span class="op">:</span><span class="va">parameter</span><span class="op">:</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<p>But it might be better to disambiguate this, perhaps wrapping subqueries in <code>{</code></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">latest</span><span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="op">{</span><span class="fu">latest</span><span class="op">(</span><span class="va">subquery</span><span class="op">)</span><span class="op">}</span><span class="op">:</span><span class="va">name</span><span class="op">)</span></span></code></pre></div>
<p>It’s not that clear, really.</p>
</div>
<div class="section level3">
<h3 id="explain-the-query">Explain the query<a class="anchor" aria-label="anchor" href="#explain-the-query"></a>
</h3>
<p>Often, people want to know “why does this packet not match”? It would be good to show where in the query some set of packets fail the query and are excluded. This would definitely be its own bit of work.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rich FitzJohn.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.5.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
